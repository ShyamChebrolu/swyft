var sModel={me:{},setObj:function(c,h){var a=$.Deferred(),b=window.openDatabase("usrCfg","1.0","User Config",10000000);function g(i){i.executeSql("SELECT * FROM usrCfg WHERE id = 1 LIMIT 1",[],e,d)}function e(i,j){a.resolve(j.rows.item(0))}function d(i){a.resolve(false)}function f(i,j){if(typeof h==="function"){h(i,j)}}if(c===true){sModel.setLang(function(){b.transaction(g,d)})}else{b.transaction(g,d)}$.when(a).then(function(i){if(typeof i!=="undefined"&&i!==false&&i!==null){sModel.me=i;setTimeout(function(){f(true,true)},1)}else{f(false,false)}})},checkObj:function(){if(typeof sModel.me.deviceUuid==="undefined"||sModel.me.deviceUuid===null||sModel.me.deviceUuid==="null"||sModel.me.deviceUuid===""||typeof sModel.me.mobileServicesUrl==="undefined"||sModel.me.mobileServicesUrl===null||sModel.me.mobileServicesUrl==="null"||sModel.me.mobileServicesUrl===""||typeof sModel.me.mobileSiteUrl==="undefined"||sModel.me.mobileSiteUrl===null||sModel.me.mobileSiteUrl==="null"||sModel.me.mobileSiteUrl===""||typeof sModel.me.clientCode==="undefined"||sModel.me.clientCode===null||sModel.me.clientCode==="null"||sModel.me.clientCode===""||typeof sModel.me.clientId==="undefined"||sModel.me.clientId===null||sModel.me.clientId==="null"||sModel.me.clientId===""){return false}else{return true}},setLang:function(b){function a(d){var c=[{objId:"lang",val:d}];sModel.tx(c,function(f,e){b(f,e)})}if(sController.app.events.params.pg===true){navigator.globalization.getLocaleName(function(c){sUtil.clog("Language Found :: "+c.value+" :: Saving");a(c.value)},function(){a("en-us")})}else{a("en-us")}},getLang:function(b){var a=$.Deferred();if(sController.app.events.params.pg===true){navigator.globalization.getLocaleName(function(c){a.resolve(c.value)},function(){a.resolve("en-us")})}else{a.resolve("en-us")}$.when(a).then(function(c){b(c)})},setGps:function(f,e,b,g){sUtil.clog('Starting GPS Update Process..."It\'s a Trap"',"gps",false);sModel.gpsCallbacks.cbHolder=(typeof g==="function")?g:false;sModel.gpsCallbacks.reDraw=(typeof e!=="undefined"&&(e===true||e===false))?e:false;sModel.gpsCallbacks.showLoading=(typeof b!=="undefined"&&(b===true||b===false))?b:false;if(b){sView.jqm.helpers.ldrWidget("show","Finding You")}var a=(f===false&&sModel.me.devicePlatform==="Android"&&sModel.me.deviceVersion<="2.3")?true:(sModel.me.devicePlatform==="Desktop")?f:f,d=(sModel.me.devicePlatform==="Android")?(a===true)?15000:30000:(sModel.me.devicePlatform==="iOS")?(a===true)?15000:30000:(sModel.me.devicePlatform==="Desktop")?500000:15000,c=(sModel.me.devicePlatform==="Android")?(a===true)?30000:10000:(sModel.me.devicePlatform==="iOS")?(a===true)?30000:10000:(sModel.me.devicePlatform==="Desktop")?6000:10000;sUtil.clog("GPS :: High accuracy is going to be :: "+a+" :: The OS is :: "+sModel.me.devicePlatform+" :: The max age will be :: "+d+" :: The Timeout will be :: "+c);navigator.geolocation.getCurrentPosition(sModel.gpsCallbacks.success,sModel.gpsCallbacks.error,{maximumAge:d,timeout:c,enableHighAccuracy:a})},gpsCallbacks:{reDraw:false,cbHolder:false,showLoading:false,success:function(a){sUtil.clog("In success CB");var b=[{objId:"deviceLat",val:a.coords.latitude},{objId:"deviceLng",val:a.coords.longitude},{objId:"gpsTimestamp",val:new Date(a.timestamp)},{objId:"deviceGps",val:"true"}];sModel.tx(b,function(c,d){sUtil.clog("in db save cb");function e(){sUtil.clog("A gps was call written to db :: Lat :"+a.coords.latitude+" Lng: "+a.coords.longitude+" Time stamp: "+new Date(a.timestamp),"gps",false);if(c){sUtil.clog("Error writing GPS TX to db","gps",true);sModel.gpsCallbacks.done(false)}else{sModel.gpsCallbacks.done(true)}}if(sModel.gpsCallbacks.reDraw===true){sView.makeMap(a,function(){e()})}else{e()}})},done:function(a){sModel.setObj(false,function(){sModel.gpsCallbacks.showLoading=false;sModel.gpsCallbacks.reDraw=false;sView.jqm.helpers.ldrWidget("hide");if(typeof sModel.gpsCallbacks.cbHolder==="function"){var b=sModel.gpsCallbacks.cbHolder;sModel.gpsCallbacks.cbHolder=null;b(a)}else{sModel.gpsCallbacks.cbHolder=null}})},error:function(a){sUtil.clog("GPS :: There was an Error getting the GPS");if(a.code==="TIMEOUT"){sUtil.clog("GPS :: TIMEOUT :: Msg :: "+a.message);sView.utils.confirm("Cannot access your location, GPS timeout.\nSwyft requires this, retry?","GPS Timeout","Retry","Exit",function(c){var b=(sModel.me.devicePlatform==="Android")?1:2;if(c===b){sModel.setGps(true,true,true,sModel.gpsCallbacks.cbHolder)}else{sModel.gpsCallbacks.cbHolder=null;sController.app.sysEvents.closeApp()}})}else{if(a.code==="PERMISSION_DENIED"){sUtil.clog("GPS :: PERMISSION_DENIED :: Msg :: "+a.message);sView.utils.confirm("You have denied GPS access to Swyft!\nError Code: 1\nPlease enable access or contact your device's administrator","GPS Error","Retry","Exit",function(c){var b=(sModel.me.devicePlatform==="Android")?1:2;if(c===b){sModel.setGps(true,true,true,sModel.gpsCallbacks.cbHolder)}else{sModel.gpsCallbacks.cbHolder=null;sController.app.sysEvents.closeApp()}})}else{if(a.code==="POSITION_UNAVAILABLE"){sUtil.clog("GPS :: POSITION_UNAVAILABLE :: Msg :: "+a.message);sView.utils.confirm("Your device has denied Swyft access to the GPS!\nError Code: 2\nPlease check your GPS or contact your device's administrator","GPS Error","Retry","Exit",function(c){var b=(sModel.me.devicePlatform==="Android")?1:2;if(c===b){sModel.setGps(true,true,true,sModel.gpsCallbacks.cbHolder)}else{sModel.gpsCallbacks.cbHolder=null;sController.app.sysEvents.closeApp()}})}else{sUtil.clog("GPS :: ERROR_CODE_UNAVAILABLE :: "+a.code+" :: Msg :: "+a.message);sView.utils.confirm("There was an Error accessing your GPS!\nPlease check your GPS or contact your device's administrator","GPS Error","Retry","Exit",function(c){var b=(sModel.me.devicePlatform==="Android")?1:2;if(c===b){sModel.setGps(true,true,true,sModel.gpsCallbacks.cbHolder)}else{sModel.gpsCallbacks.cbHolder=null;sController.app.sysEvents.closeApp()}})}}}},errorLowAccuracy:function(a){setTimeout(function(){sView.jqm.helpers.ldrWidget("hide")},1500);sUtil.clog("GPS :: gps low accuracy ERROR call failed");$("#diLattxt").attr("value","0");$("#diLngtxt").attr("value","0");$("#diLatlctxt").attr("value","00/00/00 00:00:00");sModel.gpsCallbacks.done(false)}},tx:function(g,j){var e=$.Deferred(),h={},k=[],b=[],a=false,m="",l=null;function d(n){l.transaction(function(o){o.executeSql("Update usrCfg SET "+m+" WHERE id = 1")},function(o){sUtil.clog("There was an Error Witting to the DB :: "+o.message);if(o.code===5){sController.app.sysEvents.sInit.createTbl.init(true,function(){a=true})}},function(){})}function f(n){sUtil.clog("Error writing to DB","tx",true);e.resolve()}function i(){e.resolve()}function c(n,o){$.each(n,function(p){if(typeof this.objId==="undefined"||typeof this.val==="undefined"){k.push(this)}else{m+=""+this.objId+' = "'+this.val+'"';if((p+1)<n.length){m+=", "}b.push(this)}});o()}if(typeof g==="undefined"||!g){e.resolve()}else{c(g,function(){l=window.openDatabase("usrCfg","1.0","User Config",10000000);l.transaction(d,f,i)})}$.when(e).then(function(){if(a===true){var o=k;k=[];a=false;c(o)}var n=(k.length>0);$.each(k,function(){sUtil.clog("There was en error updating the item "+this.objId,"db",false)});sModel.setObj(false,function(){if(typeof j==="function"){j(n,k)}})})}};